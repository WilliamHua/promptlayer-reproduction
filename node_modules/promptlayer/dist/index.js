"use strict";var k=Object.defineProperty,ae=Object.defineProperties,ne=Object.getOwnPropertyDescriptor,se=Object.getOwnPropertyDescriptors,ie=Object.getOwnPropertyNames,X=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable;var H=(t,e)=>{if(e=Symbol[t])return e;throw Error("Symbol."+t+" is not defined")};var z=(t,e,r)=>e in t?k(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,h=(t,e)=>{for(var r in e||(e={}))F.call(e,r)&&z(t,r,e[r]);if(X)for(var r of X(e))pe.call(e,r)&&z(t,r,e[r]);return t},g=(t,e)=>ae(t,se(e));var _=(t,e)=>{for(var r in e)k(t,r,{get:e[r],enumerable:!0})},ce=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ie(e))!F.call(t,a)&&a!==r&&k(t,a,{get:()=>e[a],enumerable:!(o=ne(e,a))||o.enumerable});return t};var le=t=>ce(k({},"__esModule",{value:!0}),t);var m=(t,e,r)=>new Promise((o,a)=>{var n=i=>{try{s(r.next(i))}catch(p){a(p)}},c=i=>{try{s(r.throw(i))}catch(p){a(p)}},s=i=>i.done?o(i.value):Promise.resolve(i.value).then(n,c);s((r=r.apply(t,e)).next())}),b=function(t,e){this[0]=t,this[1]=e},Q=(t,e,r)=>{var o=(c,s,i,p)=>{try{var w=r[c](s),T=(s=w.value)instanceof b,y=w.done;Promise.resolve(T?s[0]:s).then(l=>T?o(c==="return"?c:"next",s[1]?{done:l.done,value:l.value}:l,i,p):i({value:l,done:y})).catch(l=>o("throw",l,i,p))}catch(l){p(l)}},a=c=>n[c]=s=>new Promise((i,p)=>o(c,s,i,p)),n={};return r=r.apply(t,e),n[Symbol.asyncIterator]=()=>n,a("next"),a("throw"),a("return"),n};var V=(t,e,r)=>(e=t[H("asyncIterator")])?e.call(t):(t=t[H("iterator")](),e={},r=(o,a)=>(a=t[o])&&(e[o]=n=>new Promise((c,s,i)=>(n=a.call(t,n),i=n.done,Promise.resolve(n.value).then(p=>c({value:p,done:i}),s)))),r("next"),r("return"),e);var Le={};_(Le,{promptlayer:()=>L});module.exports=le(Le);var v={};_(v,{create:()=>fe});var q={};_(q,{getApiKey:()=>u,getPromptTemplate:()=>x,promptLayerAllPromptTemplates:()=>A,promptLayerApiRequest:()=>$,promptLayerCreateGroup:()=>j,promptLayerGetPrompt:()=>C,promptLayerPublishPrompt:()=>S,promptLayerTrackGroup:()=>W,promptLayerTrackMetadata:()=>G,promptLayerTrackPrompt:()=>O,promptLayerTrackScore:()=>I,promptlayerApiHandler:()=>R,publishPromptTemplate:()=>E});var f="https://api.promptlayer.com",u=()=>{if(L.api_key===void 0)throw new Error("Please set your PROMPTLAYER_API_KEY environment variable or set API KEY in code using 'promptlayer.api_key = <your_api_key>' ");return L.api_key},R=t=>m(void 0,null,function*(){return t.request_response[Symbol.asyncIterator]!==void 0?he(t.request_response,t):yield $(t)}),$=t=>m(void 0,null,function*(){try{let e=yield fetch(`${f}/track-request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),r=yield e.json();if(e.status!==200&&P(r,"WARNING: While logging your request, PromptLayer experienced the following error:"),r&&t.return_pl_id)return[t.request_response,r.request_id]}catch(e){console.warn(`WARNING: While logging your request PromptLayer had the following error: ${e}`)}return t.request_response}),A=t=>m(void 0,null,function*(){let e=new URL(`${f}/rest/prompts`);Object.entries(t||{}).forEach(([r,o])=>e.searchParams.append(r,o));try{let r=yield fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-API-KEY":u()}}),o=yield r.json();return r.status!==200&&console.warn(`WARNING: While fetching all prompt templates, PromptLayer had the following error: ${JSON.stringify(o)}`),o}catch(r){console.warn(`WARNING: While fetching all prompt templates, PromptLayer had the following error: ${r}`)}}),C=t=>m(void 0,null,function*(){var n,c,s;let e={prompt_name:t.prompt_name,version:(c=(n=t.version)==null?void 0:n.toString())!=null?c:"",label:(s=t.label)!=null?s:""},r=new URL(`${f}/library-get-prompt-template`);r.search=new URLSearchParams(e).toString();let o;try{o=yield fetch(r.toString(),{method:"GET",headers:{"X-API-KEY":u()}})}catch(i){throw new Error(`PromptLayer had the following error while getting your prompt: ${i}`)}let a=yield o.json();return o.status!==200&&Z(a,"PromptLayer had the following error while retrieving your prompt template"),a}),S=t=>m(void 0,null,function*(){let e;try{e=yield fetch(`${f}/library-publish-prompt-template`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},t),{api_key:u()}))})}catch(o){throw new Error(`PromptLayer had the following error while publishing your prompt template: ${o}`)}let r=yield e.json();return e.status!==200&&Z(r,"PromptLayer had the following error while publishing your prompt"),!0}),G=t=>m(void 0,null,function*(){try{let e=yield fetch(`${f}/library-track-metadata`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},t),{api_key:u()}))}),r=yield e.json();if(e.status!==200)return P(r,"WARNING: While logging metadata to your request, PromptLayer experienced the following error"),!1}catch(e){return console.warn(`WARNING: While logging metadata to your request, PromptLayer experienced the following error: ${e}`),!1}return!0}),I=t=>m(void 0,null,function*(){try{let e=yield fetch(`${f}/library-track-score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},t),{api_key:u()}))}),r=yield e.json();if(e.status!==200)return P(r,"WARNING: While scoring your request, PromptLayer experienced the following error"),!1}catch(e){return console.warn(`WARNING: While scoring your request, PromptLayer experienced the following error: ${e}`),!1}return!0}),O=t=>m(void 0,null,function*(){try{let e=yield fetch(`${f}/library-track-prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},t),{api_key:u()}))}),r=yield e.json();if(e.status!==200)return P(r,"WARNING: While associating your request with a prompt template, PromptLayer experienced the following error"),!1}catch(e){return console.warn(`WARNING: While associating your request with a prompt template, PromptLayer experienced the following error: ${e}`),!1}return!0}),W=t=>m(void 0,null,function*(){try{let e=yield fetch(`${f}/track-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},t),{api_key:u()}))}),r=yield e.json();if(e.status!==200)return P(r,"WARNING: While associating your request with a group, PromptLayer experienced the following error"),!1}catch(e){return console.warn(`WARNING: While associating your request with a group, PromptLayer experienced the following error: ${e}`),!1}return!0}),j=()=>m(void 0,null,function*(){try{let t=yield fetch(`${f}/create-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:u()})}),e=yield t.json();return t.status!==200?(P(e,"WARNING: While creating a group PromptLayer had the following error"),!1):e.id}catch(t){return console.warn(`WARNING: While creating a group PromptLayer had the following error: ${t}`),!1}}),x=(t,e)=>m(void 0,null,function*(){try{let r=new URL(`${f}/prompt-templates/${t}`),o=yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":u()},body:JSON.stringify(g(h({},e),{api_key:u()}))}),a=yield o.json();return o.status!==200?(P(a,"WARNING: While fetching a prompt template PromptLayer had the following error"),null):a}catch(r){return console.warn(`WARNING: While fetching a prompt template PromptLayer had the following error: ${r}`),null}}),E=t=>m(void 0,null,function*(){try{let e=yield fetch(`${f}/rest/prompt-templates`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":u()},body:JSON.stringify({prompt_template:h({},t),prompt_version:h({},t)})}),r=yield e.json();return e.status===400&&P(r,"WARNING: While publishing a prompt template PromptLayer had the following error"),r}catch(e){console.warn(`WARNING: While publishing a prompt template PromptLayer had the following error: ${e}`)}}),me=t=>{var c,s,i,p,w;let e=null,r,o={id:"",choices:[],created:Date.now(),model:"",object:"chat.completion"},a=t.at(-1);if(!a)return o;let n;for(let T of t){let y=T.choices[0].delta;y.content&&(e=`${e||""}${y.content||""}`),y.function_call&&(r={name:`${r?r.name:""}${y.function_call.name||""}`,arguments:`${r?r.arguments:""}${y.function_call.arguments||""}`});let l=(c=y.tool_calls)==null?void 0:c[0];if(l){n=n||[];let d=n.at(-1);if(!d||l.id){n.push({id:l.id||"",type:l.type||"function",function:{name:((s=l.function)==null?void 0:s.name)||"",arguments:((i=l.function)==null?void 0:i.arguments)||""}});continue}d.function.name=`${d.function.name}${((p=l.function)==null?void 0:p.name)||""}`,d.function.arguments=`${d.function.arguments}${((w=l.function)==null?void 0:w.arguments)||""}`}}return o.choices.push({finish_reason:a.choices[0].finish_reason||"stop",index:a.choices[0].index||0,logprobs:a.choices[0].logprobs||null,message:{role:"assistant",content:e,function_call:r||void 0,tool_calls:n||void 0}}),o.id=a.id,o.model=a.model,o.created=a.created,o.system_fingerprint=a.system_fingerprint,o},ue=t=>{if("completion"in t[0])return t.reduce((e,r)=>g(h({},r),{completion:`${e.completion}${r.completion}`}),{});if("text"in t[0].choices[0]){let e="";for(let o of t)e=`${e}${o.choices[0].text}`;let r=structuredClone(t.at(-1));return r.choices[0].text=e,r}if("delta"in t[0].choices[0]){let e=me(t);return e.choices[0]=h(h({},e.choices[0]),e.choices[0].message),e}return""};function he(t,e){return Q(this,null,function*(){let r=[];try{for(var n=V(t),c,s,i;c=!(s=yield new b(n.next())).done;c=!1){let p=s.value;yield p,r.push(p)}}catch(s){i=[s]}finally{try{c&&(s=n.return)&&(yield new b(s.call(n)))}finally{if(i)throw i[0]}}let o=ue(r);yield yield new b($(g(h({},e),{request_response:o,request_end_time:new Date().toISOString()})))})}var P=(t,e)=>{try{console.warn(`${e}: ${t.message}`)}catch(r){console.warn(`${e}: ${t}`)}},Z=(t,e)=>{throw"message"in t?new Error(`${e}: ${t.message}`):new Error(`${e}: ${t.message}`)};var fe=()=>m(void 0,null,function*(){return yield j()});var ee=(t,e="",r="openai")=>{let o={construct:(a,n)=>{let c=Reflect.construct(a,n);return Object.defineProperties(c,{function_name:{value:e,writable:!0},provider:{value:r}}),new Proxy(c,o)},get:(a,n,c)=>{let s=a[n],i=`${Reflect.get(a,"function_name")}.${n.toString()}`;return typeof s=="object"?(Object.defineProperties(s,{function_name:{value:i,writable:!0},provider:{value:r}}),new Proxy(s,o)):typeof s=="function"?(...p)=>{var M,U,B,D;let w=new Date().toISOString(),T=Reflect.get(a,"provider"),y=(M=p[0])==null?void 0:M.return_pl_id,l=(U=p[0])==null?void 0:U.pl_tags;(B=p[0])==null||delete B.return_pl_id,(D=p[0])==null||delete D.pl_tags;let d=Reflect.apply(s,a,p);return d instanceof Promise?new Promise((te,re)=>{d.then(N=>m(void 0,null,function*(){let oe=yield R({api_key:u(),provider_type:T,function_name:i,request_start_time:w,request_end_time:new Date().toISOString(),request_response:N,kwargs:p[0],return_pl_id:y,tags:l});te(oe)})).catch(N=>{re(N)})}):d}:Reflect.get(a,n,c)}};return new Proxy(t,o)};var J={};_(J,{all:()=>ye,get:()=>de,publish:()=>ge});var ye=t=>A(t),de=t=>m(void 0,null,function*(){let e=yield C(t),r=e.prompt_template,o=e.metadata;return{prompt_template:r,metadata:o}}),ge=t=>{let{prompt_template:e,commit_message:r}=t;if(r&&r.length>72)throw new Error("Commit message must be less than 72 characters.");if(!(e instanceof Object))throw new Error("Please provide a JSON prompt template.");return S(t)};var Y={};_(Y,{get:()=>Pe,publish:()=>we});var Pe=(t,e)=>x(t,e),we=t=>E(t);var K={};_(K,{group:()=>ke,metadata:()=>Te,prompt:()=>be,score:()=>_e});var Te=t=>{if(!(t.metadata instanceof Object))throw new Error("Please provide a dictionary of metadata.");for(let[e,r]of Object.entries(t.metadata))if(typeof e!="string"||typeof r!="string")throw new Error("Please provide a dictionary of metadata with key value pair of strings.");return G(t)},_e=t=>{if(typeof t.score!="number")throw new Error("Score must be a number");if(t.score<0||t.score>100)throw new Error("Score must be a number between 0 and 100.");return I(t)},be=t=>{if(!(t.prompt_input_variables instanceof Object))throw new Error("Prompt template input variable dictionary not provided.");return O(t)},ke=t=>W(t);var L=new Proxy({OpenAI:{},Anthropic:{},api_key:process.env.PROMPTLAYER_API_KEY,utils:q,track:K,groups:v,prompts:J,templates:Y},{get:(t,e,r)=>{if(["OpenAI","Anthropic"].includes(e.toString())){let o=e==="OpenAI"?"openai":"@anthropic-ai/sdk",a=require(o).default;return ee(a,e.toString().toLowerCase(),e.toString().toLowerCase())}return Reflect.get(t,e,r)}});0&&(module.exports={promptlayer});
//# sourceMappingURL=index.js.map