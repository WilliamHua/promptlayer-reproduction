var z=Object.defineProperty,ae=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var se=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var X=(e,t)=>{if(t=Symbol[e])return t;throw Error("Symbol."+e+" is not defined")};var H=(e,t,r)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,h=(e,t)=>{for(var r in t||(t={}))se.call(t,r)&&H(e,r,t[r]);if(D)for(var r of D(t))ie.call(t,r)&&H(e,r,t[r]);return e},g=(e,t)=>ae(e,ne(t));var F=(e=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(e,{get:(t,r)=>(typeof require!="undefined"?require:t)[r]}):e)(function(e){if(typeof require!="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var _=(e,t)=>{for(var r in t)z(e,r,{get:t[r],enumerable:!0})};var m=(e,t,r)=>new Promise((o,a)=>{var n=i=>{try{s(r.next(i))}catch(p){a(p)}},c=i=>{try{s(r.throw(i))}catch(p){a(p)}},s=i=>i.done?o(i.value):Promise.resolve(i.value).then(n,c);s((r=r.apply(e,t)).next())}),b=function(e,t){this[0]=e,this[1]=t},Q=(e,t,r)=>{var o=(c,s,i,p)=>{try{var w=r[c](s),T=(s=w.value)instanceof b,y=w.done;Promise.resolve(T?s[0]:s).then(l=>T?o(c==="return"?c:"next",s[1]?{done:l.done,value:l.value}:l,i,p):i({value:l,done:y})).catch(l=>o("throw",l,i,p))}catch(l){p(l)}},a=c=>n[c]=s=>new Promise((i,p)=>o(c,s,i,p)),n={};return r=r.apply(e,t),n[Symbol.asyncIterator]=()=>n,a("next"),a("throw"),a("return"),n};var V=(e,t,r)=>(t=e[X("asyncIterator")])?t.call(e):(e=e[X("iterator")](),t={},r=(o,a)=>(a=e[o])&&(t[o]=n=>new Promise((c,s,i)=>(n=a.call(e,n),i=n.done,Promise.resolve(n.value).then(p=>c({value:p,done:i}),s)))),r("next"),r("return"),t);var q={};_(q,{create:()=>me});var E={};_(E,{getApiKey:()=>u,getPromptTemplate:()=>j,promptLayerAllPromptTemplates:()=>$,promptLayerApiRequest:()=>R,promptLayerCreateGroup:()=>W,promptLayerGetPrompt:()=>A,promptLayerPublishPrompt:()=>C,promptLayerTrackGroup:()=>O,promptLayerTrackMetadata:()=>S,promptLayerTrackPrompt:()=>I,promptLayerTrackScore:()=>G,promptlayerApiHandler:()=>N,publishPromptTemplate:()=>x});var f="https://api.promptlayer.com",u=()=>{if(L.api_key===void 0)throw new Error("Please set your PROMPTLAYER_API_KEY environment variable or set API KEY in code using 'promptlayer.api_key = <your_api_key>' ");return L.api_key},N=e=>m(void 0,null,function*(){return e.request_response[Symbol.asyncIterator]!==void 0?le(e.request_response,e):yield R(e)}),R=e=>m(void 0,null,function*(){try{let t=yield fetch(`${f}/track-request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=yield t.json();if(t.status!==200&&P(r,"WARNING: While logging your request, PromptLayer experienced the following error:"),r&&e.return_pl_id)return[e.request_response,r.request_id]}catch(t){console.warn(`WARNING: While logging your request PromptLayer had the following error: ${t}`)}return e.request_response}),$=e=>m(void 0,null,function*(){let t=new URL(`${f}/rest/prompts`);Object.entries(e||{}).forEach(([r,o])=>t.searchParams.append(r,o));try{let r=yield fetch(t,{method:"GET",headers:{"Content-Type":"application/json","X-API-KEY":u()}}),o=yield r.json();return r.status!==200&&console.warn(`WARNING: While fetching all prompt templates, PromptLayer had the following error: ${JSON.stringify(o)}`),o}catch(r){console.warn(`WARNING: While fetching all prompt templates, PromptLayer had the following error: ${r}`)}}),A=e=>m(void 0,null,function*(){var n,c,s;let t={prompt_name:e.prompt_name,version:(c=(n=e.version)==null?void 0:n.toString())!=null?c:"",label:(s=e.label)!=null?s:""},r=new URL(`${f}/library-get-prompt-template`);r.search=new URLSearchParams(t).toString();let o;try{o=yield fetch(r.toString(),{method:"GET",headers:{"X-API-KEY":u()}})}catch(i){throw new Error(`PromptLayer had the following error while getting your prompt: ${i}`)}let a=yield o.json();return o.status!==200&&Z(a,"PromptLayer had the following error while retrieving your prompt template"),a}),C=e=>m(void 0,null,function*(){let t;try{t=yield fetch(`${f}/library-publish-prompt-template`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},e),{api_key:u()}))})}catch(o){throw new Error(`PromptLayer had the following error while publishing your prompt template: ${o}`)}let r=yield t.json();return t.status!==200&&Z(r,"PromptLayer had the following error while publishing your prompt"),!0}),S=e=>m(void 0,null,function*(){try{let t=yield fetch(`${f}/library-track-metadata`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},e),{api_key:u()}))}),r=yield t.json();if(t.status!==200)return P(r,"WARNING: While logging metadata to your request, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While logging metadata to your request, PromptLayer experienced the following error: ${t}`),!1}return!0}),G=e=>m(void 0,null,function*(){try{let t=yield fetch(`${f}/library-track-score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},e),{api_key:u()}))}),r=yield t.json();if(t.status!==200)return P(r,"WARNING: While scoring your request, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While scoring your request, PromptLayer experienced the following error: ${t}`),!1}return!0}),I=e=>m(void 0,null,function*(){try{let t=yield fetch(`${f}/library-track-prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},e),{api_key:u()}))}),r=yield t.json();if(t.status!==200)return P(r,"WARNING: While associating your request with a prompt template, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While associating your request with a prompt template, PromptLayer experienced the following error: ${t}`),!1}return!0}),O=e=>m(void 0,null,function*(){try{let t=yield fetch(`${f}/track-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g(h({},e),{api_key:u()}))}),r=yield t.json();if(t.status!==200)return P(r,"WARNING: While associating your request with a group, PromptLayer experienced the following error"),!1}catch(t){return console.warn(`WARNING: While associating your request with a group, PromptLayer experienced the following error: ${t}`),!1}return!0}),W=()=>m(void 0,null,function*(){try{let e=yield fetch(`${f}/create-group`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_key:u()})}),t=yield e.json();return e.status!==200?(P(t,"WARNING: While creating a group PromptLayer had the following error"),!1):t.id}catch(e){return console.warn(`WARNING: While creating a group PromptLayer had the following error: ${e}`),!1}}),j=(e,t)=>m(void 0,null,function*(){try{let r=new URL(`${f}/prompt-templates/${e}`),o=yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":u()},body:JSON.stringify(g(h({},t),{api_key:u()}))}),a=yield o.json();return o.status!==200?(P(a,"WARNING: While fetching a prompt template PromptLayer had the following error"),null):a}catch(r){return console.warn(`WARNING: While fetching a prompt template PromptLayer had the following error: ${r}`),null}}),x=e=>m(void 0,null,function*(){try{let t=yield fetch(`${f}/rest/prompt-templates`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":u()},body:JSON.stringify({prompt_template:h({},e),prompt_version:h({},e)})}),r=yield t.json();return t.status===400&&P(r,"WARNING: While publishing a prompt template PromptLayer had the following error"),r}catch(t){console.warn(`WARNING: While publishing a prompt template PromptLayer had the following error: ${t}`)}}),pe=e=>{var c,s,i,p,w;let t=null,r,o={id:"",choices:[],created:Date.now(),model:"",object:"chat.completion"},a=e.at(-1);if(!a)return o;let n;for(let T of e){let y=T.choices[0].delta;y.content&&(t=`${t||""}${y.content||""}`),y.function_call&&(r={name:`${r?r.name:""}${y.function_call.name||""}`,arguments:`${r?r.arguments:""}${y.function_call.arguments||""}`});let l=(c=y.tool_calls)==null?void 0:c[0];if(l){n=n||[];let d=n.at(-1);if(!d||l.id){n.push({id:l.id||"",type:l.type||"function",function:{name:((s=l.function)==null?void 0:s.name)||"",arguments:((i=l.function)==null?void 0:i.arguments)||""}});continue}d.function.name=`${d.function.name}${((p=l.function)==null?void 0:p.name)||""}`,d.function.arguments=`${d.function.arguments}${((w=l.function)==null?void 0:w.arguments)||""}`}}return o.choices.push({finish_reason:a.choices[0].finish_reason||"stop",index:a.choices[0].index||0,logprobs:a.choices[0].logprobs||null,message:{role:"assistant",content:t,function_call:r||void 0,tool_calls:n||void 0}}),o.id=a.id,o.model=a.model,o.created=a.created,o.system_fingerprint=a.system_fingerprint,o},ce=e=>{if("completion"in e[0])return e.reduce((t,r)=>g(h({},r),{completion:`${t.completion}${r.completion}`}),{});if("text"in e[0].choices[0]){let t="";for(let o of e)t=`${t}${o.choices[0].text}`;let r=structuredClone(e.at(-1));return r.choices[0].text=t,r}if("delta"in e[0].choices[0]){let t=pe(e);return t.choices[0]=h(h({},t.choices[0]),t.choices[0].message),t}return""};function le(e,t){return Q(this,null,function*(){let r=[];try{for(var n=V(e),c,s,i;c=!(s=yield new b(n.next())).done;c=!1){let p=s.value;yield p,r.push(p)}}catch(s){i=[s]}finally{try{c&&(s=n.return)&&(yield new b(s.call(n)))}finally{if(i)throw i[0]}}let o=ce(r);yield yield new b(R(g(h({},t),{request_response:o,request_end_time:new Date().toISOString()})))})}var P=(e,t)=>{try{console.warn(`${t}: ${e.message}`)}catch(r){console.warn(`${t}: ${e}`)}},Z=(e,t)=>{throw"message"in e?new Error(`${t}: ${e.message}`):new Error(`${t}: ${e.message}`)};var me=()=>m(void 0,null,function*(){return yield W()});var ee=(e,t="",r="openai")=>{let o={construct:(a,n)=>{let c=Reflect.construct(a,n);return Object.defineProperties(c,{function_name:{value:t,writable:!0},provider:{value:r}}),new Proxy(c,o)},get:(a,n,c)=>{let s=a[n],i=`${Reflect.get(a,"function_name")}.${n.toString()}`;return typeof s=="object"?(Object.defineProperties(s,{function_name:{value:i,writable:!0},provider:{value:r}}),new Proxy(s,o)):typeof s=="function"?(...p)=>{var K,M,U,B;let w=new Date().toISOString(),T=Reflect.get(a,"provider"),y=(K=p[0])==null?void 0:K.return_pl_id,l=(M=p[0])==null?void 0:M.pl_tags;(U=p[0])==null||delete U.return_pl_id,(B=p[0])==null||delete B.pl_tags;let d=Reflect.apply(s,a,p);return d instanceof Promise?new Promise((te,re)=>{d.then(k=>m(void 0,null,function*(){let oe=yield N({api_key:u(),provider_type:T,function_name:i,request_start_time:w,request_end_time:new Date().toISOString(),request_response:k,kwargs:p[0],return_pl_id:y,tags:l});te(oe)})).catch(k=>{re(k)})}):d}:Reflect.get(a,n,c)}};return new Proxy(e,o)};var v={};_(v,{all:()=>ue,get:()=>he,publish:()=>fe});var ue=e=>$(e),he=e=>m(void 0,null,function*(){let t=yield A(e),r=t.prompt_template,o=t.metadata;return{prompt_template:r,metadata:o}}),fe=e=>{let{prompt_template:t,commit_message:r}=e;if(r&&r.length>72)throw new Error("Commit message must be less than 72 characters.");if(!(t instanceof Object))throw new Error("Please provide a JSON prompt template.");return C(e)};var J={};_(J,{get:()=>ye,publish:()=>de});var ye=(e,t)=>j(e,t),de=e=>x(e);var Y={};_(Y,{group:()=>Te,metadata:()=>ge,prompt:()=>we,score:()=>Pe});var ge=e=>{if(!(e.metadata instanceof Object))throw new Error("Please provide a dictionary of metadata.");for(let[t,r]of Object.entries(e.metadata))if(typeof t!="string"||typeof r!="string")throw new Error("Please provide a dictionary of metadata with key value pair of strings.");return S(e)},Pe=e=>{if(typeof e.score!="number")throw new Error("Score must be a number");if(e.score<0||e.score>100)throw new Error("Score must be a number between 0 and 100.");return G(e)},we=e=>{if(!(e.prompt_input_variables instanceof Object))throw new Error("Prompt template input variable dictionary not provided.");return I(e)},Te=e=>O(e);var L=new Proxy({OpenAI:{},Anthropic:{},api_key:process.env.PROMPTLAYER_API_KEY,utils:E,track:Y,groups:q,prompts:v,templates:J},{get:(e,t,r)=>{if(["OpenAI","Anthropic"].includes(t.toString())){let a=F(t==="OpenAI"?"openai":"@anthropic-ai/sdk").default;return ee(a,t.toString().toLowerCase(),t.toString().toLowerCase())}return Reflect.get(e,t,r)}});export{L as promptlayer};
//# sourceMappingURL=index.js.map